<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRAC Question Drill App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 md:p-10 transition-all duration-300 transform">
        <h1 class="text-3xl font-black text-gray-900 mb-8 text-center">HRAC System Login</h1>
        
        <div id="status-card" class="bg-indigo-50 border-l-8 border-indigo-600 text-indigo-800 p-4 rounded-xl mb-8 flex items-center justify-between shadow-inner" role="alert">
            <p id="auth-status" class="font-semibold">Initializing application...</p>
        </div>

        <div id="main-app" class="space-y-10 hidden">
            <button onclick="showPerformanceSummary()" class="w-full px-4 py-2 text-sm bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition-colors duration-200">
                Performance Summary
            </button>

            <div id="page-content-container"></div>
            
            <div class="bg-gray-50 p-4 rounded-lg shadow-md border border-gray-200 mt-8 text-sm">
                <p class="font-semibold text-gray-700">Current Session:</p>
                <p id="user-email-display" class="text-indigo-600 font-medium break-words mt-1">Loading...</p>
                <p class="font-semibold text-gray-700 mt-3">Session ID:</p>
                <code id="user-id-display" class="block w-full text-xs break-all bg-white p-2 rounded-md border border-gray-300 text-gray-800">Loading...</code>
            </div>
            <button id="sign-out-btn" onclick="signOutUser()" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-xl shadow-lg hover:bg-red-700 transition-colors duration-200">Sign Out</button>
        </div>

        <div id="sign-in-options" class="space-y-5 hidden">
            <p class="text-center text-gray-500 font-medium">Use your Google account to sign in:</p>
            <button id="google-sign-in-btn" onclick="signInWithGoogle()" class="w-full flex items-center justify-center px-6 py-3 bg-white border border-gray-300 text-gray-700 font-semibold rounded-xl shadow-md hover:bg-gray-50 transition-colors duration-200">
                <svg class="google-icon" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.23 9.21 3.29l5.47-5.47C36.67 4.71 30.55 2 24 2 13.4 2 4.9 8.2 1.5 17.3L12 24.4l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4c0-.71.01-1.4.01-2.1 0-7.85-6.17-14.8-14.5-14.8z"/><path fill="#4285F4" d="M46.5 24.4l-7.23-5.26c-2.5-1.92-5.75-3.04-9.27-3.04s-6.77 1.12-9.27 3.04L1.5 24.4c3.4 9.1 11.9 15.3 22.5 15.3 5.4 0 10.7-1.9 14.8-5.3L36 31.7l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4z"/><path fill="#FBBC05" d="M1.5 24.4L12 31.5l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4l-7.23-5.26c-2.5-1.92-5.75-3.04-9.27-3.04s-6.77 1.12-9.27 3.04L1.5 24.4z"/><path fill="#34A853" d="M12 31.5l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4l-7.23-5.26c-2.5-1.92-5.75-3.04-9.27-3.04s-6.77 1.12-9.27 3.04L1.5 24.4V40.2c3.4-9.1 11.9-15.3 22.5-15.3 5.4 0 10.7-1.9 14.8-5.3L36 31.7l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71z"/></svg>
                Sign in with Google
            </button>
        </div>
        <p id="error-message" class="text-center text-red-500 mt-4 hidden"></p>
    </div>

    <div id="quiz-modal" class="modal-backdrop hidden">
        <div class="modal-content space-y-6">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Quiz Options</h2>
            <div class="flex flex-col space-y-3">
                <button onclick="startPractice(10)" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Practice with 10 Questions</button>
                <button onclick="startPractice(20)" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Practice with 20 Questions</button>
                <button onclick="startTest()" class="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">Do the Test</button>
            </div>
            <button onclick="hideQuizOptions()" class="mt-4 text-gray-500 hover:text-gray-700">Cancel</button>
        </div>
    </div>

    <div id="performance-modal" class="modal-backdrop hidden">
        <div class="modal-content space-y-4">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">Your Performance</h2>
            <div id="performance-list" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-500">Loading performance data...</p>
            </div>
            <button onclick="hidePerformanceSummary()" class="mt-4 text-gray-500 hover:text-gray-700 w-full py-2 border rounded">Close</button>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyB1yiiAMR3pPa6-Jzhjaq0k7CDPB3L_C44",
        authDomain: "hrac-game.firebaseapp.com",
        projectId: "hrac-game",
        storageBucket: "hrac-game.firebasestorage.app",
        messagingSenderId: "72236369603",
        appId: "1:72236369603:web:553ecd8299842073f3c476",
        measurementId: "G-GW7PZEKZJ7"
    };
    
    // --- Element References ---
    const statusElement = document.getElementById('auth-status');
    const mainApp = document.getElementById('main-app');
    const signInOptions = document.getElementById('sign-in-options');
    const pageContentContainer = document.getElementById('page-content-container');
    const quizModal = document.getElementById('quiz-modal');
    const modalTitle = document.getElementById('modal-title');

    // ðŸŸ¢ NEW: Get reference to the performance modal elements
    const performanceModal = document.getElementById('performance-modal');
    const performanceList = document.getElementById('performance-list');
    
    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app); // ðŸŸ¢ NEW: Initialize Firestore DB

    // --- State Variables ---
    let currentQuizId = null; 
    let currentPage = '';

    // --- NEW: Core Page Loading Function ---
    // This function just handles fetching and displaying the content.
    async function loadPageContent(pageId) {
        if (!pageId) pageId = 'landing'; // Default to landing page
        try {
            const response = await fetch(`templates/${pageId}.html`);
            if (!response.ok) throw new Error('Template not found');
            pageContentContainer.innerHTML = await response.text();
            currentPage = pageId;
        } catch (e) {
            pageContentContainer.innerHTML = `<p class="text-red-500 text-center">Error loading content for ${pageId}.</p>`;
        }
    }

    // --- UPDATED: Navigation Function ---
    // This function now updates the browser's history.
    window.navigateTo = function(pageId) {
        if (pageId === currentPage) return;
        const url = `#${pageId}`;
        // Add a new entry to the browser's history
        history.pushState({ page: pageId }, '', url);
        loadPageContent(pageId);
    }

    // --- NEW: Handle Browser Back/Forward Buttons ---
    // This listens for when the user clicks the browser's back or forward buttons.
    window.onpopstate = function(event) {
        if (event.state && event.state.page) {
            loadPageContent(event.state.page);
        } else {
            // If there's no state, it's the initial page load, go to landing
            loadPageContent('landing');
        }
    };

    window.showQuizOptions = (title, quizId) => {
        currentQuizId = quizId;
        modalTitle.textContent = title;
        quizModal.classList.remove('hidden');
    };

    window.hideQuizOptions = () => quizModal.classList.add('hidden');
    
    // --- Quiz Navigation Functions (Unchanged) ---
    window.startSavedDrill = function() {
        const params = new URLSearchParams({ mode: 'saved', title: 'Saved Questions Drill' });
        window.location.href = `practice-quiz.html?${params.toString()}`;
    };
    
    window.startPractice = function(count) {
        hideQuizOptions();
        let params;
        if (currentQuizId === 'class111_quiz1') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac111quiz1.txt', afile: 'questionbank/hrac111quiz1answer.txt', title: `HRAC 111 - Quiz 1 Practice`, count: count });
        } else if (currentQuizId === 'class111_test1') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac111test1.txt', afile: 'questionbank/hrac111test1answer.txt', title: `HRAC 111 - Test 1 Practice`, count: count });
        } else if (currentQuizId === 'class111_week1') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac111week1.txt', afile: 'questionbank/hrac111week1answer.txt', title: `HRAC 111 - Week 1 Practice`, count: count });
        } else if (currentQuizId === 'class111_week2') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac111week2.txt', afile: 'questionbank/hrac111week2answer.txt', title: `HRAC 111 - Week 2 Practice`, count: count });
        } else if (currentQuizId === 'class111_week3_4') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac111week34.txt', afile: 'questionbank/hrac111week34answer.txt', title: `HRAC 111 - Week 3&4 Practice`, count: count });
        } else if (currentQuizId === 'class111_week5') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac111week5.txt', afile: 'questionbank/hrac111week5answer.txt', title: `HRAC 111 - Week 5 Practice`, count: count });
        } 
        else if (currentQuizId === 'class112_test1') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac112test1.txt', afile: 'questionbank/hrac112test1answer.txt', title: `HRAC 112 - Test 1 Practice`, count: count });
        } else if (currentQuizId === 'class112_week1') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac112week1.txt', afile: 'questionbank/hrac112week1answer.txt', title: `HRAC 112 - Week 1 Practice`, count: count });
        } else if (currentQuizId === 'class112_week2') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac112week2.txt', afile: 'questionbank/hrac112week2answer.txt', title: `HRAC 112 - Week 2 Practice`, count: count });
        } else if (currentQuizId === 'class112_week3') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac112week3.txt', afile: 'questionbank/hrac112week3answer.txt', title: `HRAC 112 - Week 3 Practice`, count: count });
        } else if (currentQuizId === 'class112_week4') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac112week4.txt', afile: 'questionbank/hrac112week4answer.txt', title: `HRAC 112 - Week 4 Practice`, count: count });
        } else if (currentQuizId === 'class112_week5') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac112week5.txt', afile: 'questionbank/hrac112week5answer.txt', title: `HRAC 112 - Week 5 Practice`, count: count });
        } else if (currentQuizId === 'class124_test1') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac124test1.txt', afile: 'questionbank/hrac124test1answer.txt', title: `HRAC 124 - Test 1 Practice`, count: count });
        } else if (currentQuizId === 'RACTEC_unit7') {
             params = new URLSearchParams({ qfile: 'questionbank/hracunit7set1.txt', afile: 'questionbank/hracunit7set1answer.txt',title: `HRAC 124 - Unit 7 Practice`, count: count });
        } else if (currentQuizId === 'class113_slide1to5') {
             params = new URLSearchParams({ qfile: 'questionbank/hrac113slide1to5.txt', afile: 'questionbank/hrac113slide1to5answer.txt',title: `HRAC 124 - Unit 7 Practice`, count: count });
        }
        else {
            alert('This practice session is not yet implemented.');
            return;
        }
        window.location.href = `practice-quiz.html?${params.toString()}`;
    };

    window.startTest = function() {
        hideQuizOptions();
        let params;
        if (currentQuizId === 'class111_quiz1') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac111quiz1.txt', afile: 'questionbank/hrac111quiz1answer.txt', title: 'HRAC 111 - Quiz 1 Test' });
        } else if (currentQuizId === 'class111_test1') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac111test1.txt', afile: 'questionbank/hrac111test1answer.txt', title: 'HRAC 111 - Test 1' });
        } else if (currentQuizId === 'class111_week1') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac111week1.txt', afile: 'questionbank/hrac111week1answer.txt', title: 'HRAC 111 - Week 1 Test' });
        } else if (currentQuizId === 'class111_week2') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac111week2.txt', afile: 'questionbank/hrac111week2answer.txt', title: 'HRAC 111 - Week 2 Test' });
        } else if (currentQuizId === 'class111_week3_4') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac111week34.txt', afile: 'questionbank/hrac111week34answer.txt', title: 'HRAC 111 - Week 3&4 Test' });
        } else if (currentQuizId === 'class111_week5') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac111week5.txt', afile: 'questionbank/hrac111week5answer.txt', title: 'HRAC 111 - Week 5 Test' });
        } 
        else if (currentQuizId === 'class112_test1') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac112test1.txt', afile: 'questionbank/hrac112test1answer.txt', title: 'HRAC 112 - Test 1' });
        } else if (currentQuizId === 'class112_week1') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac112week1.txt', afile: 'questionbank/hrac112week1answer.txt', title: 'HRAC 112 - Week 1 Test' });
        } else if (currentQuizId === 'class112_week2') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac112week2.txt', afile: 'questionbank/hrac112week2answer.txt', title: 'HRAC 112 - Week 2 Test' });
        } else if (currentQuizId === 'class112_week3') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac112week3.txt', afile: 'questionbank/hrac112week3answer.txt', title: 'HRAC 112 - Week 3 Test' });
        } else if (currentQuizId === 'class112_week4') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac112week4.txt', afile: 'questionbank/hrac112week4answer.txt', title: 'HRAC 112 - Week 4 Test' });
        } else if (currentQuizId === 'class112_week5') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac112week5.txt', afile: 'questionbank/hrac112week5answer.txt', title: 'HRAC 112 - Week 5 Test' });
        } else if (currentQuizId === 'class124_test1') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac124test1.txt', afile: 'questionbank/hrac124test1answer.txt', title: 'HRAC 124 - Test 1' });
        } else if (currentQuizId === 'RACTEC_unit7') {
            params = new URLSearchParams({ qfile: 'questionbank/hracunit7set1.txt',afile: 'questionbank/hracunit7set1answer.txt',title: 'HRAC 124 - Unit 7 Test' });
        } else if (currentQuizId === 'class113_slide1to5') {
            params = new URLSearchParams({ qfile: 'questionbank/hrac113slide1to5.txt',afile: 'questionbank/hrac113slide1to5answer.txt',title: 'HRAC 124 - Unit 7 Test' });
        }
        else {
            alert('This specific test is not yet implemented.');
            return;
        }
        window.location.href = `quiz.html?${params.toString()}`;
    };
    
    // --- Authentication Logic (Unchanged) ---
    const googleProvider = new GoogleAuthProvider();
    const googleSignInBtn = document.getElementById('google-sign-in-btn');
    const errorMessage = document.getElementById('error-message');
    const googleIconSvg = `<svg class="google-icon" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.23 9.21 3.29l5.47-5.47C36.67 4.71 30.55 2 24 2 13.4 2 4.9 8.2 1.5 17.3L12 24.4l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4c0-.71.01-1.4.01-2.1 0-7.85-6.17-14.8-14.5-14.8z"/><path fill="#4285F4" d="M46.5 24.4l-7.23-5.26c-2.5-1.92-5.75-3.04-9.27-3.04s-6.77 1.12-9.27 3.04L1.5 24.4c3.4 9.1 11.9 15.3 22.5 15.3 5.4 0 10.7-1.9 14.8-5.3L36 31.7l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4z"/><path fill="#FBBC05" d="M1.5 24.4L12 31.5l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4l-7.23-5.26c-2.5-1.92-5.75-3.04-9.27-3.04s-6.77 1.12-9.27 3.04L1.5 24.4z"/><path fill="#34A853" d="M12 31.5l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71L46.5 24.4l-7.23-5.26c-2.5-1.92-5.75-3.04-9.27-3.04s-6.77 1.12-9.27 3.04L1.5 24.4V40.2c3.4-9.1 11.9-15.3 22.5-15.3 5.4 0 10.7-1.9 14.8-5.3L36 31.7l1.24-.71c2.47-1.42 5.56-2.29 8.76-2.29s6.29.87 8.76 2.29l1.24.71z"/></svg> Sign in with Google`;
    window.signInWithGoogle = async () => { errorMessage.classList.add('hidden'); googleSignInBtn.disabled = true; googleSignInBtn.textContent = 'Awaiting popup...'; try { await signInWithPopup(auth, googleProvider); } catch (error) { console.error("Google Sign-in Failed:", error); if (error.code !== 'auth/popup-closed-by-user') { errorMessage.textContent = `Login Error: ${error.message}`; errorMessage.classList.remove('hidden'); } googleSignInBtn.disabled = false; googleSignInBtn.innerHTML = googleIconSvg; } };
    window.signOutUser = async () => { try { await signOut(auth); } catch (error) { console.error("Sign Out Error:", error); } };
    
    // --- UPDATED: Auth State Change Handler ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            mainApp.classList.remove('hidden');
            signInOptions.classList.add('hidden');
            document.getElementById('user-email-display').textContent = user.email;
            document.getElementById('user-id-display').textContent = user.uid;
            statusElement.textContent = `âœ… Logged in as: ${user.email}`;
            statusElement.parentElement.classList.replace('border-indigo-600', 'border-green-600');
            statusElement.parentElement.classList.replace('bg-indigo-50', 'bg-green-50');
            
            // Check the URL hash to load the correct page on startup
            const initialPage = window.location.hash.substring(1) || 'landing';
            // Use replaceState so the initial page load doesn't create a "back" entry
            history.replaceState({ page: initialPage }, '', `#${initialPage}`);
            loadPageContent(initialPage);

        } else {
            mainApp.classList.add('hidden');
            signInOptions.classList.remove('hidden');
            statusElement.textContent = "Please sign in with Google.";
            statusElement.parentElement.classList.replace('border-green-600', 'border-indigo-600');
            statusElement.parentElement.classList.replace('bg-green-50', 'bg-indigo-50');
            pageContentContainer.innerHTML = ''; 
            currentPage = '';
            // Clear the hash on logout
            history.replaceState(null, '', window.location.pathname);
        }
    });

    // index.html (inside <script type="module">)

    window.hidePerformanceSummary = () => performanceModal.classList.add('hidden');

    window.showPerformanceSummary = async function() {
        if (!auth.currentUser) return;

        performanceModal.classList.remove('hidden');
        performanceList.innerHTML = '<p class="text-center text-indigo-600">Loading performance data...</p>';

        try {
            const userId = auth.currentUser.uid;
            const performanceRef = collection(db, "users", userId, "questionSetPerformance");
            
            // Fetch ALL documents in the user's questionSetPerformance subcollection
            const q = query(performanceRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                performanceList.innerHTML = '<p class="text-center text-gray-500">No practice attempts recorded yet!</p>';
                return;
            }

            let html = '';
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const set = data.questionSet || 'Unknown Set'; // Gets the question set name
                const percent = data.percentage !== undefined ? data.percentage.toFixed(1) : 'N/A'; // Gets the percentage

                html += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <span class="font-medium text-gray-700">${set}</span>
                        <span class="text-lg font-bold ${percent >= 70 ? 'text-green-600' : 'text-red-600'}">${percent}%</span>
                    </div>
                `;
            });
            
            performanceList.innerHTML = html;

        } catch (error) {
            console.error("Error fetching performance summary:", error);
            performanceList.innerHTML = '<p class="text-center text-red-500">Failed to load data. Please check console.</p>';
        }
    };
</script>
</body>
</html>