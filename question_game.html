<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Game</title>
    
    <link rel="stylesheet" href="styles.css"> 
    
    <style>
        /* Define colors (Pulled from previous files for consistency) */
        :root {
            --primary-color: #4285F4; /* Google Blue */
            --background-light: #f7f9fc;
            --card-background: #ffffff;
            --text-color: #3c4043;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --secondary-color: #27ae60; /* Success Green */
            --error-color: #e74c3c; /* Error Red */
            --star-color: gold; /* New color for the star */
        }
        
        .game-container {
            max-width: 800px;
            width: 90%;
            margin: 40px auto;
            padding: 30px;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 10px 25px var(--shadow-color);
        }
        
        /* --- NEW ADMIN CONTROL STYLES --- */
        #admin-control {
            /* Hidden by default in HTML, shown via JS if isAdmin=true */
            display: none; 
            gap: 10px;
            align-items: center;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px dashed #ccc;
            border-radius: 6px;
            background-color: #fff3e0; /* Light orange background to distinguish it */
        }

        #admin-control label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color);
            margin-right: 5px;
        }

        #new-answer-index-input {
            width: 50px;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--error-color);
            border-radius: 4px;
            font-weight: 700;
        }

        #change-answer-btn {
            background-color: var(--error-color);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        #change-answer-btn:hover {
            background-color: #c0392b;
        }
        /* --- END ADMIN CONTROL STYLES --- */


        #question-area {
            min-height: 100px;
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: relative; /* Added for star positioning */
        }

        #question-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 0;
            margin-bottom: 15px;
            padding-right: 35px; /* Ensure space for the star */
            display: inline-block; /* Allows vertical alignment with star */
            width: calc(100% - 35px);
        }

        /* --- NEW STAR STYLES --- */
        #drill-star {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.8rem;
            cursor: pointer;
            color: #ccc; /* Default grey (unticked) */
            transition: color 0.2s;
        }

        #drill-star.active {
            color: var(--star-color); /* Gold (ticked) */
        }
        /* --- END STAR STYLES --- */


        .option-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            background-color: white;
            color: var(--primary-color);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover:not(:disabled) {
            background-color: var(--background-light);
        }
        
        /* Answer Feedback States */
        .option-button.correct {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: white;
            font-weight: 700;
        }
        
        .option-button.incorrect {
            background-color: var(--error-color);
            border-color: var(--error-color);
            color: white;
        }
        
        .option-button:disabled {
            cursor: default;
            opacity: 0.7;
        }

        #next-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 500;
            display: none; /* Hidden until an answer is selected */
            width: 100%;
        }

        /* --- NEW/REVISED BUTTON STYLES --- */
        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%; /* Make action buttons full width */
        }
        
        /* Apply a consistent style to all action buttons (Play Again, Next) */
        #restart-btn {
             background-color: var(--primary-color);
             color: white;
        }
        
        /* Style for the "Back to Question Bank" buttons */
        #back-to-bank-btn, #results-back-btn {
            /* Now using the primary color, but styled as a secondary action */
            background-color: transparent; 
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 8px 15px; /* Slightly smaller padding than the main Next/Restart buttons */
            margin-top: 15px; 
            font-size: 0.95rem;
        }
        
        #back-to-bank-btn:hover, #results-back-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }
        /* --- END NEW/REVISED BUTTON STYLES --- */

        
        #progress-bar {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        #progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            transition: width 0.3s;
        }
        
        /* Results View */
        #results-view {
            text-align: center;
        }
        #results-view h2 {
            color: var(--secondary-color);
            font-size: 2rem;
        }

    </style>
</head>
<body>

    <div class="game-container"> 
        
        <h1 id="set-title">Quiz Game</h1>
        
        <div id="admin-control" style="display: none;">
            <label for="new-answer-index-input">Update Correct Answer (0-3):</label>
            <input type="number" id="new-answer-index-input" min="0" max="3" placeholder="0-3" value="" disabled>
            <button id="change-answer-btn" disabled>Change</button>
        </div>
        <div id="loading-state">
            <p style="text-align: center;">Loading Question Data...</p>
        </div>

        <div id="quiz-view" style="display: none;">
            
            <button id="back-to-bank-btn" class="action-btn" style="margin-bottom: 20px;">
                ← Back to Question Bank
            </button>
            <p id="current-score">Score: 0 / 0</p>
            <div id="progress-bar"><div id="progress-bar-fill"></div></div>

            <div id="question-area">
                <p id="question-text">Question content will appear here.</p>
                <span id="drill-star" data-drill="false">★</span>
                <div id="options-container">
                    </div>
            </div>
            
            <button id="next-btn">Next Question</button>
            
            </div>
        
        <div id="results-view" style="display: none;">
            <h2 id="final-result-text"></h2>
            <p id="final-score-text"></p>
            <button id="restart-btn" class="action-btn">Play Again</button>
            <button id="results-back-btn" class="action-btn">
                ← Back to Question Bank
            </button>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration and Initialization
        const firebaseConfig = {
            apiKey: "AIzaSyCTySJ47HQAQJLk-2jbxld_7Yx4YeSTrJQ",
            authDomain: "questionbank-8edee.firebaseapp.com",
            projectId: "questionbank-8edee",
            storageBucket: "questionbank-8edee.firebasestorage.app",
            messagingSenderId: "916266107755",
            appId: "1:916266107755:web:8697df896deb8479e6422e",
            measurementId: "G-DRFYPLC7GX"
        };
        // Use the default app instance to pick up the existing Google session
        const app = firebase.initializeApp(firebaseConfig); 
        const db = firebase.firestore(app);
        const auth = firebase.auth(app); 


        // --- Game State Variables ---
        let questions = [];        // Array of questions loaded from Storage
        let currentQuestionIndex = 0;
        let score = 0;
        let isAuthenticated = false; 
        let currentUserID = null; 
        let isAdmin = false; // ⬅️ FIX: Defined globally
        
        // 💥 ADMIN CONFIGURATION: Your unique Firebase ID 💥
        const ADMIN_UID = "sVwKTNtFV1VXWx5rmDZe5C3Zh0y1";

        // --- Element References ---
        const loadingState = document.getElementById('loading-state');
        const quizView = document.getElementById('quiz-view');
        const resultsView = document.getElementById('results-view');
        const setTitle = document.getElementById('set-title');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const nextBtn = document.getElementById('next-btn');
        const currentScore = document.getElementById('current-score');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const drillStar = document.getElementById('drill-star');
        
        const finalResultText = document.getElementById('final-result-text');
        const finalScoreText = document.getElementById('final-score-text');
        
        const backToBankBtn = document.getElementById('back-to-bank-btn');
        const resultsBackBtn = document.getElementById('results-back-btn');
        const restartBtn = document.getElementById('restart-btn');

        // Admin Control Elements
        const newAnswerIndexInput = document.getElementById('new-answer-index-input');
        const changeAnswerBtn = document.getElementById('change-answer-btn');
        const adminControl = document.getElementById('admin-control'); // ⬅️ Element reference added
        
        // --- Core Functions ---
        
        function loadQuestions() {
            loadingState.style.display = 'block';
            
            // 1. Retrieve the question data from session storage
            const questionPackageJson = sessionStorage.getItem('gameQuestionData');
            sessionStorage.removeItem('gameQuestionData'); 
            
            console.log("--- RECEIVED QUESTION PACKAGE (from sessionStorage) ---");
            
            if (!questionPackageJson) {
                setTitle.textContent = 'Error Loading Quiz';
                loadingState.innerHTML = '<p style="color: red;">Question data not found. Please select a set from the Question Bank.</p>';
                setTimeout(() => window.location.href = 'question-bank.html', 3000);
                return;
            }

            try {
                // 2. Decode and parse the JSON string
                questions = JSON.parse(questionPackageJson);
                
                console.log("--- PARSED QUESTION PACKAGE ---");
                console.log("Total Questions:", questions.length);
                
                if (questions.length === 0) {
                    setTitle.textContent = 'Error Loading Quiz';
                    loadingState.innerHTML = '<p style="color: red;">Loaded data contains zero questions. Returning to Question Bank...</p>';
                    setTimeout(() => window.location.href = 'question-bank.html', 3000);
                    return;
                }
                
                // 3. Initialization
                setTitle.textContent = questions[0].name || 'Question Game';
                loadingState.style.display = 'none';
                quizView.style.display = 'block';
                
                startQuiz();

            } catch (e) {
                console.error("Error parsing question data:", e);
                setTitle.textContent = 'Data Error';
                loadingState.innerHTML = '<p style="color: red;">Failed to parse question data. Returning to Question Bank...</p>';
                setTimeout(() => window.location.href = 'question-bank.html', 3000);
            }
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            resultsView.style.display = 'none';
            quizView.style.display = 'block';
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showResults();
                return;
            }

            const currentQ = questions[currentQuestionIndex];
            
            // Update UI elements
            questionText.textContent = `Q${currentQuestionIndex + 1}: ${currentQ.text}`;
            optionsContainer.innerHTML = '';
            nextBtn.style.display = 'none';
            
            // Check and Sync Star UI State
            const isDrilled = currentQ.drill === 'true'; 
            if (isDrilled) {
                 drillStar.classList.add('active');
            } else {
                 drillStar.classList.remove('active');
            }
            drillStar.setAttribute('data-drill', isDrilled ? 'true' : 'false');

            // 💥 Admin Control UI: Always enabled for admin, empty value 💥
            if (isAdmin) {
                newAnswerIndexInput.value = ''; // Empty on load
                newAnswerIndexInput.disabled = false; 
                changeAnswerBtn.disabled = false; 
            }

            currentQ.options.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = optionText;
                button.setAttribute('data-index', index);
                button.addEventListener('click', handleAnswerSelection);
                optionsContainer.appendChild(button);
            });
            
            updateProgress();
        }
        
        // Function to handle the star toggle (unchanged)
        async function handleStarToggle() {
            // Check authentication status immediately
            if (!isAuthenticated || !currentUserID) {
                console.error("❌ ERROR: User is not authenticated. Cannot record drill status.");
                alert("You are not authorized to save the drill status. Please log in first.");
                return;
            }
            
            const currentQ = questions[currentQuestionIndex];
            const isDrill = drillStar.getAttribute('data-drill') === 'true';
            
            // 1. Determine new state and toggle UI (optimistic update)
            const newDrillStatus = isDrill ? "false" : "true";
            
            // Toggle UI immediately for better user experience
            if (isDrill) {
                drillStar.classList.remove('active');
            } else {
                drillStar.classList.add('active');
            }
            drillStar.setAttribute('data-drill', newDrillStatus);
            
            // 2. Prepare package for logging and Firestore insertion
            const recordPackage = {
                userId: currentUserID,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                question_id: currentQ.question_id,
                uploadFileName: currentQ.uploadFileName, 
                action: 'drill_star_toggle',
                newDrillStatus: newDrillStatus,
                questionText: currentQ.text.substring(0, 100) + '...'
            };

            console.log(`\n--- DRILL STATUS TOGGLE (Recording to userRecord) ---`);
            
            // 3. FIREBASE INSERT LOGIC
            try {
                await db.collection('userRecord').add(recordPackage);
                console.log(`✅ SUCCESS: Drill toggle recorded to 'userRecord' collection.`);
            } catch (error) {
                console.error("🔥 FATAL FIREBASE RECORDING ERROR:", error);
                drillStar.setAttribute('data-drill', isDrill ? 'true' : 'false');
                if (isDrill) { drillStar.classList.add('active'); } else { drillStar.classList.remove('active'); }
                alert("An error occurred while recording the drill status log. Check console.");
            }
            console.log("-------------------------------------------------------");
        }


        // 💥 CORRECTED ASYNC FUNCTION TO UPDATE THE CORRECT ANSWER 💥
        async function changeAnswer() {
            
            // 1. DEFINE VARIABLES FIRST (Ensuring scope is correct)
            const currentQ = questions[currentQuestionIndex];
            const newAnswerIndex = parseInt(newAnswerIndexInput.value, 10);
            
            // 2. Authorization Check (Uses global isAdmin)
            if (!isAdmin) {
                alert("Authorization failed. Only the designated admin can change the answer.");
                return;
            }

            // 3. Basic Validation
            if (isNaN(newAnswerIndex) || newAnswerIndex < 0 || newAnswerIndex > 3) {
                alert("Invalid index. Please enter a number between 0 and 3.");
                return;
            }

            // 4. CONFIRMATION STEP 
            const isConfirmed = confirm(`Do you want to update the correct answer for Question ID ${currentQ.question_id} to index ${newAnswerIndex}? This change will be permanent in the database.`);

            if (!isConfirmed) {
                console.log("Answer update cancelled by user.");
                return; // Stop the function if the user cancels
            }
            
            // Disable controls during update
            changeAnswerBtn.disabled = true;
            newAnswerIndexInput.disabled = true; 
            changeAnswerBtn.textContent = 'Updating...';

            // 5. Find the Document in Firestore's 'questionBank' collection
            try {
                const questionBankRef = db.collection('questionBank');
                
                const snapshot = await questionBankRef
                    .where('question_id', '==', currentQ.question_id)
                    .where('uploadFileName', '==', currentQ.uploadFileName)
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    alert("❌ Error: Could not find the corresponding question document in the database.");
                    console.error("No document found for update:", currentQ);
                    return;
                }

                const docRef = snapshot.docs[0].ref;
                const oldAnswer = currentQ.answer;

                // 6. Update the Answer Field
                await docRef.update({
                    answer: newAnswerIndex
                });

                // 7. Update the client-side question object
                currentQ.answer = newAnswerIndex; 
                
                // 8. Success Feedback
                alert(`✅ SUCCESS! Answer for ${currentQ.question_id} updated from ${oldAnswer} to ${newAnswerIndex} in Firestore.`);

            } catch (error) {
                console.error("🔥 FATAL FIREBASE UPDATE ERROR:", error);
                alert(`An error occurred while updating the answer: ${error.message}`);
            } finally {
                // Re-enable controls
                changeAnswerBtn.disabled = false;
                changeAnswerBtn.textContent = 'Change';
                newAnswerIndexInput.disabled = false; 
            }
        }


        function handleAnswerSelection(event) {
            const selectedButton = event.target;
            const selectedIndex = parseInt(selectedButton.getAttribute('data-index'), 10);
            const currentQ = questions[currentQuestionIndex];
            
            // Disable all option buttons
            optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                btn.disabled = true;
            });

            // Check answer and update score/UI
            const isCorrect = selectedIndex === currentQ.answer;

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++;
            } else {
                selectedButton.classList.add('incorrect');
                // Highlight the correct answer
                const correctButton = optionsContainer.querySelector(`[data-index="${currentQ.answer}"]`);
                if(correctButton) {
                    correctButton.classList.add('correct');
                }
            }
            
            // Console Log all requested fields
            console.log("--- ANSWER SELECTED ---");
            console.log("Question ID:", currentQ.question_id); 
            console.log("Source File:", currentQ.uploadFileName); 
            console.log("Selected Answer Index (0-3):", selectedIndex);
            console.log("Correct Answer Index (0-3):", currentQ.answer); 
            console.log("Result:", isCorrect ? "CORRECT" : "INCORRECT");
            console.log("-----------------------");
            
            // Show the Next button
            nextBtn.style.display = 'block';
            updateScore();
        }

        function updateProgress() {
            const progress = (currentQuestionIndex / questions.length) * 100;
            progressBarFill.style.width = `${progress}%`;
            updateScore(); 
        }
        
        function updateScore() {
            const answered = currentQuestionIndex;
            const total = questions.length;
            currentScore.textContent = `Score: ${score} / ${answered} (Total: ${total} Qs)`;
        }

        function showResults() {
            quizView.style.display = 'none';
            resultsView.style.display = 'block';
            
            progressBarFill.style.width = '100%'; 
            
            const total = questions.length;
            const percentage = (score / total) * 100;
            
            finalScoreText.textContent = `You scored ${score} out of ${total} (${percentage.toFixed(0)}%).`;
            
            if (percentage >= 80) {
                finalResultText.textContent = "Excellent!";
            } else if (percentage >= 50) {
                finalResultText.textContent = "Good Effort!";
            } else {
                finalResultText.textContent = "Keep Practicing!";
            }
        }
        
        // --- Event Listeners and Initialization ---
        
        nextBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            displayQuestion();
        });
        
        restartBtn.addEventListener('click', startQuiz);
        drillStar.addEventListener('click', handleStarToggle);
        
        // Event listener for the Change Answer button
        changeAnswerBtn.addEventListener('click', changeAnswer);

        // Navigation back to the bank (shared function for both buttons)
        const goBackToBank = () => {
             window.location.href = 'question-bank.html';
        };

        backToBankBtn.addEventListener('click', goBackToBank);
        resultsBackBtn.addEventListener('click', goBackToBank);


        // CORE AUTHENTICATION CHECK
        auth.onAuthStateChanged(user => {
            if (user) {
                isAuthenticated = true;
                currentUserID = user.uid;
                
                // ⬅️ FIX: Set the global isAdmin flag
                isAdmin = (user.uid === ADMIN_UID);
                
                console.log(`Authentication: User session found. User ID: ${user.uid}. Admin check: ${isAdmin}`);
            } else {
                isAuthenticated = false;
                currentUserID = null;
                isAdmin = false;
                console.log("Authentication: No active user session found.");
            }
            
            // ⬅️ FIX: Control Admin UI Visibility
            if (adminControl) {
                // Set display to 'flex' (from CSS) or 'none'
                adminControl.style.display = isAdmin ? 'flex' : 'none'; 
            }

            loadQuestions();
        });
        
    </script>
</body>
</html>