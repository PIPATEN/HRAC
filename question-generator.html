<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Generator - Secure Access</title>
    
    <link rel="stylesheet" href="styles.css"> 
    
    <style>
        /* Import a modern, clean font from Google Fonts (Roboto) */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        /* Define colors, including the new secondary color for the sub-toggle */
        :root {
            --primary-color: #4285F4; /* Google Blue (Main Toggle) */
            --secondary-color: #27ae60; /* Success Green (Sub-Toggle) */
            --background-light: #f7f9fc;
            --card-background: #ffffff;
            --text-color: #3c4043;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        /* --- STYLES REMOVED: Tab Navigation --- */
        
        /* Layout specific to the generator form */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        /* Style input and select fields identically */
        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
            appearance: none; /* Remove default OS styling for select */
            background-color: white;
            /* Optional: Add a custom arrow for select */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.9L146.2%20208.7L5.4%2069.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
        }

        .action-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .action-btn:hover {
             background-color: #357ae8;
        }
        
        /* Utility Classes for Toggling Content */
        .hidden {
            display: none !important;
        }

        /* Styling for the Loading Spinner */
        .loading {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary-color); 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Toggle Switch Styling (Main: Class/Book) --- */
        .toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 4px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toggle-btn {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            background-color: transparent;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .toggle-btn.active {
            background-color: var(--primary-color); /* Primary Blue for main toggle */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* --- STYLES FOR SUB-TOGGLE (Quiz/Weekly) --- */
        .sub-toggle-container {
            margin-bottom: 10px; /* Reduced margin */
            padding: 3px; /* Smaller padding */
            background-color: #e9f5e9; /* Light green background */
        }
        
        .sub-toggle-btn {
            padding: 6px 12px; /* Smaller button size */
            font-size: 0.85rem; /* Smaller text */
            font-weight: 400; /* Lighter font weight */
        }

        .sub-toggle-btn.active {
            background-color: var(--secondary-color); /* Secondary Green for sub-toggle */
            color: white;
        }
        /* --- END STYLES --- */


        /* --- NEW WIDTH RULES FOR LARGE SCREENS --- */
        .login-container.app-container {
            max-width: 1000px; /* Adjusted max-width to accommodate 3 columns */
            width: 90%; 
            transition: max-width 0.3s ease-in-out;
        }

        /* --- GRID LAYOUT FOR FORM FIELDS --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default: Single column for mobile */
            gap: 20px; 
        }

        /* Apply three-column layout when the main container is wide (logged in) */
        .app-container .form-grid {
            grid-template-columns: repeat(3, 1fr); /* CHANGED TO 3 COLUMNS */
        }

        /* Force file uploads and submit button to span all columns */
        .grid-span-2 {
            grid-column: 1 / -1; /* Spans all 3 columns */
        }
        
        /* New styling to separate the two main sections */
        .section-separator {
            margin: 40px 0;
            border: 0;
            border-top: 2px solid #ddd;
            width: 100%;
        }
        
        .section-header {
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 25px;
            text-align: left;
        }

    </style>
    
</head>
<body>

    <div class="login-container" id="main-container"> 
        
        <h1>Question System</h1> 
        
        <div id="loading-state">
            <div class="loading"></div>
            <p>Checking authentication...</p>
        </div>

        <div id="sign-in-state" class="hidden">
            <p>You must sign in to access the generator.</p>
            
            <button id="google-login-btn">
                Sign in with Google
            </button> 
            
            <p id="error-message" style="color: red; margin-top: 15px;"></p>
        </div>
        
        <div id="app-content" class="hidden">
            <p style="text-align: right; font-size: 0.8rem; color: #555;">
                Welcome, <span id="user-display-name">User</span>!
            </p>
            
            <div id="upload-generator-tab">
                <h2 class="section-header">File Uploader</h2>
                <form id="question-form"> 

                    <div class="toggle-container grid-span-2">
                        <button type="button" id="classToggle" class="toggle-btn active" data-mode="class">Class</button>
                        <button type="button" id="bookToggle" class="toggle-btn" data-mode="book">Book</button>
                    </div>
                    
                    <div class="form-grid">
                        
                        <div class="form-group book-field hidden" id="fg-bookNameSelect">
                            <label for="bookNameSelect">Book Name</label>
                            <select id="bookNameSelect" required disabled>
                                <option value="rac-tec-book">R&AC Tec Book</option>
                                <option value="149-1-book">149.1 Book</option>
                            </select>
                        </div>

                        <div class="form-group book-field hidden" id="fg-unitNumberInput">
                            <label for="unitNumberInput">Unit Number</label>
                            <input type="text" id="unitNumberInput" placeholder="e.g., Unit 5, Chapter 3" required disabled>
                        </div>
                        
                        <div class="form-group class-field" id="fg-classSelect">
                            <label for="classSelect">Class</label>
                            <select id="classSelect" required>
                                <option value="HRAC111">HRAC111</option>
                                <option value="HRAC112">HRAC112</option>
                                <option value="HRAC113">HRAC113</option>
                                <option value="HRAC124">HRAC124</option>
                            </select>
                        </div>

                        <div class="toggle-container sub-toggle-container class-field grid-span-2" id="classSubToggleContainer">
                            <button type="button" id="quizTestToggle" class="toggle-btn sub-toggle-btn active" data-sub-mode="quizTest">Quiz & Test</button>
                            <button type="button" id="weeklyMaterialToggle" class="toggle-btn sub-toggle-btn" data-sub-mode="weeklyMaterial">Weekly Material</button>
                        </div>

                        <div class="form-group class-field" id="fg-quizTestName">
                            <label for="quizTestName">Quiz & Test Name</label>
                            <input type="text" id="quizTestName" placeholder="e.g., Midterm Exam, Quiz 3" required>
                        </div>

                        <div class="form-group class-field hidden" id="fg-weeklyMaterialSelect">
                            <label for="weeklyMaterialSelect">Weekly Material</label>
                            <select id="weeklyMaterialSelect" required disabled>
                                <option value="" disabled selected>Select Week</option>
                                <option value="week-1">Week 1</option>
                                <option value="week-2">Week 2</option>
                                <option value="week-3">Week 3</option>
                                <option value="week-4">Week 4</option>
                                <option value="week-5">Week 5</option>
                                <option value="week-6">Week 6</option>
                                <option value="week-7">Week 7</option>
                                <option value="week-8">Week 8</option>
                                <option value="week-9">Week 9</option>
                                <option value="week-10">Week 10</option>
                                <option value="week-11">Week 11</option>
                                <option value="week-12">Week 12</option>
                                <option value="week-13">Week 13</option>
                                <option value="week-14">Week 14</option>
                            </select>
                        </div>

                        <div class="form-group" id="fg-questionTypeSelect">
                            <label for="questionTypeSelect">Question Type</label>
                            <select id="questionTypeSelect" required>
                                <option value="multiple-choice" selected>Multiple Choice</option>
                                <option value="fill-in-the-blank">Fill in the Blank</option>
                            </select>
                        </div>
                        
                        <div class="grid-span-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="uploadQuestionData">Upload Question Set Data (.csv, .json, .txt)</label>
                                <input type="file" id="uploadQuestionData" accept=".csv, .json, .txt" required>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="uploadAnswerData">Upload Answer Data (.csv, .json, .txt)</label>
                                <input type="file" id="uploadAnswerData" accept=".csv, .json, .txt">
                            </div>
                            
                        </div>
                        
                    </div>
                    
                    <button type="submit" class="action-btn">
                        Generate Questions
                    </button>
                </form>
            </div>
            
            <hr class="section-separator">
            
            <div id="web-generator-tab">
                <h2 class="section-header">Web Generator</h2>
                <p>Select an existing question set to generate content from it, or create a new one.</p>
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / 3;"> 
                        <label for="questionSetsSelect">Question Sets</label>
                        <select id="questionSetsSelect">
                            <option value="" disabled selected>Select a Question Set...</option>
                            </select>
                    </div>
                    <div class="form-group" style="grid-column: 3 / 4; align-self: end;"> 
                        <button type="button" id="loadQuestionSetBtn" class="action-btn" style="width: 100%; margin-top: 0;">
                            Load Questions
                        </button>
                    </div>
                </div>

                <button type="button" id="generateWebContentBtn" class="action-btn grid-span-2" style="width: 100%; margin-top: 20px;">
                    Generate Web Content
                </button>
                
            </div>

            <button id="logout-btn" class="action-btn" style="background-color: #e74c3c; margin-top: 30px;">
                Sign Out
            </button>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="main.js"></script>
    
    <script src="generator-logic.js"></script> 

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const mainContainer = document.getElementById('main-container'); 
        const appContent = document.getElementById('app-content');
        
        // --- REMOVED: Tab Elements (tabButtons, switchTab function) ---
        const uploadTab = document.getElementById('upload-generator-tab'); // Still needed for context
        const webTab = document.getElementById('web-generator-tab');       // Still needed for context
        
        // --- Current Toggling Logic Elements ---
        const classToggle = document.getElementById('classToggle');
        const bookToggle = document.getElementById('bookToggle');
        const classFields = document.querySelectorAll('.class-field'); 
        const bookFields = document.querySelectorAll('.book-field'); 
        const classSelectDropdown = document.getElementById('classSelect');
        const bookNameSelect = document.getElementById('bookNameSelect');
        const unitNumberInput = document.getElementById('unitNumberInput');
        const quizTestToggle = document.getElementById('quizTestToggle');
        const weeklyMaterialToggle = document.getElementById('weeklyMaterialToggle');
        const quizTestGroup = document.getElementById('fg-quizTestName');
        const weeklyMaterialGroup = document.getElementById('fg-weeklyMaterialSelect');
        const quizTestInput = document.getElementById('quizTestName');
        const weeklyMaterialSelect = document.getElementById('weeklyMaterialSelect');
        
        // --- ELEMENTS FOR WEB GENERATOR ---
        const questionSetsSelect = document.getElementById('questionSetsSelect');
        const loadQuestionSetBtn = document.getElementById('loadQuestionSetBtn');
        const generateWebContentBtn = document.getElementById('generateWebContentBtn'); // New: Get the button
        const errorMessage = document.getElementById('error-message');


        // 💥 CORRECTED ASYNC FUNCTION TO LOAD QUESTION SETS 💥
        async function loadQuestionSetsForWebGenerator() {
            if (!db) {
                console.error("Firestore database object 'db' is not initialized.");
                return;
            }
            
            // Clear existing options, but keep the disabled placeholder
            const placeholder = questionSetsSelect.querySelector('option[disabled]');
            questionSetsSelect.innerHTML = '';
            if (placeholder) {
                questionSetsSelect.appendChild(placeholder);
            }
            
            // Temporary feedback for the user
            errorMessage.textContent = 'Loading question sets...';
            errorMessage.style.color = '#4285F4'; // Blue for loading
            loadQuestionSetBtn.disabled = true;
            generateWebContentBtn.disabled = true; // Disable generate button while loading
            
            try {
                // Query the 'questionSets' collection for documents where webStatus is "false"
                const snapshot = await db.collection('questionSets')
                                         .where('webStatus', '==', 'false')
                                         .get();

                if (snapshot.empty) {
                    errorMessage.textContent = 'No question sets found for web generation.';
                    errorMessage.style.color = 'red';
                    
                } else {
                    // Populate the select dropdown
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const option = document.createElement('option');
                        // CORRECTED: Use the document ID (which is the uploadFileName) for both value and text
                        option.value = doc.id; 
                        option.textContent = `${doc.id}`;
                        questionSetsSelect.appendChild(option);
                    });
                    
                    errorMessage.textContent = `✅ Loaded ${snapshot.size} file names.`;
                    errorMessage.style.color = '#27ae60'; // Green for success
                    generateWebContentBtn.disabled = false; // Enable button only if sets are loaded
                }


            } catch (error) {
                console.error("Error fetching question sets:", error);
                errorMessage.textContent = `❌ Error loading sets: ${error.message}`;
                errorMessage.style.color = 'red';
            } finally {
                loadQuestionSetBtn.disabled = false;
            }
        }
        
        
        // 💥 NEW ASYNC FUNCTION TO UPDATE WEBSTATUS IN FIREBASE 💥
        async function updateWebStatus() {
            if (!db) {
                console.error("Firestore database object 'db' is not initialized.");
                errorMessage.textContent = '❌ Database not connected.';
                errorMessage.style.color = 'red';
                return;
            }
            
            const selectedSetId = questionSetsSelect.value;
            
            if (!selectedSetId) {
                errorMessage.textContent = '⚠️ Please load questions and select a set first.';
                errorMessage.style.color = '#ff9800'; // Orange for warning
                return;
            }
            
            errorMessage.textContent = `Updating status for ${selectedSetId}...`;
            errorMessage.style.color = '#4285F4'; 
            generateWebContentBtn.disabled = true;
            loadQuestionSetBtn.disabled = true;


            try {
                // Reference the document by its ID (which is the uploadFileName)
                const setDocRef = db.collection('questionSets').doc(selectedSetId); 
                
                // Update the webStatus field to "true"
                await setDocRef.update({
                    webStatus: "true"
                });

                errorMessage.textContent = `✅ Web Content Generated! Status for ${selectedSetId} set to TRUE.`;
                errorMessage.style.color = '#27ae60';
                
                // After successful update, reload the dropdown to remove the now-processed set
                await loadQuestionSetsForWebGenerator(); 

            } catch (error) {
                console.error("🔥 FIREBASE UPDATE ERROR:", error);
                errorMessage.textContent = `❌ Failed to update status: ${error.message}`;
                errorMessage.style.color = 'red';
            } finally {
                generateWebContentBtn.disabled = false;
                loadQuestionSetBtn.disabled = false;
            }
        }

        
        // --- Add event listener to the Load Questions button (Kept from previous step) ---
        if (loadQuestionSetBtn) {
            loadQuestionSetBtn.addEventListener('click', () => {
                loadQuestionSetsForWebGenerator();
            });
        }
        
        // 💥 Add event listener to the Generate Web Content button 💥
        if (generateWebContentBtn) {
            generateWebContentBtn.addEventListener('click', () => {
                updateWebStatus();
            });
        }


        // Function to manage the internal Class mode fields (Unchanged)
        function setClassMode(subMode) {
            if (subMode === 'quizTest') {
                // UI State
                quizTestToggle.classList.add('active');
                weeklyMaterialToggle.classList.remove('active');

                // Visibility
                quizTestGroup.classList.remove('hidden');
                weeklyMaterialGroup.classList.add('hidden');

                // Required/Disabled State
                quizTestInput.required = true;
                quizTestInput.disabled = false;
                weeklyMaterialSelect.required = false;
                weeklyMaterialSelect.disabled = true;

            } else if (subMode === 'weeklyMaterial') {
                // UI State
                weeklyMaterialToggle.classList.add('active');
                quizTestToggle.classList.remove('active');

                // Visibility
                weeklyMaterialGroup.classList.remove('hidden');
                quizTestGroup.classList.add('hidden');

                // Required/Disabled State
                weeklyMaterialSelect.required = true;
                weeklyMaterialSelect.disabled = false;
                quizTestInput.required = false;
                quizTestInput.disabled = true;
            }
        }


        // Function to manage the main Class vs. Book mode (Unchanged)
        function setMode(mode) {
            if (mode === 'class') {
                // 1. UI Toggle State
                classToggle.classList.add('active');
                bookToggle.classList.remove('active');

                // 2. Input Visibility (Show Class, Hide Book)
                classFields.forEach(el => el.classList.remove('hidden'));
                bookFields.forEach(el => el.classList.add('hidden'));
                
                // 3. Required/Disabled State (Sets general class fields and calls sub-mode default)
                classSelectDropdown.required = true;
                
                bookNameSelect.required = false;
                bookNameSelect.disabled = true;
                unitNumberInput.required = false; 
                unitNumberInput.disabled = true;

                // Set the internal mode default to Quiz & Test
                setClassMode('quizTest'); 

            } else if (mode === 'book') {
                // 1. UI Toggle State
                bookToggle.classList.add('active');
                classToggle.classList.remove('active');

                // 2. Input Visibility (Show Book, Hide Class)
                classFields.forEach(el => el.classList.add('hidden'));
                bookFields.forEach(el => el.classList.remove('hidden'));

                // 3. Required/Disabled State (Also disables all class sub-mode fields)
                classSelectDropdown.required = false;
                
                quizTestInput.required = false;
                quizTestInput.disabled = true;
                weeklyMaterialSelect.required = false;
                weeklyMaterialSelect.disabled = true;

                bookNameSelect.required = true;
                bookNameSelect.disabled = false;
                unitNumberInput.required = true; 
                unitNumberInput.disabled = false;
            }
        }
        
        // Set initial modes on load
        setMode('class');
        // REMOVED: switchTab('upload-generator'); 

        // Add main toggle event listeners (Unchanged)
        classToggle.addEventListener('click', () => setMode('class'));
        bookToggle.addEventListener('click', () => setMode('book'));
        
        // Add sub-toggle event listeners (Unchanged)
        quizTestToggle.addEventListener('click', () => setClassMode('quizTest'));
        weeklyMaterialToggle.addEventListener('click', () => setClassMode('weeklyMaterial'));
        
        // --- Authentication State Manager (Handles the overall container width) (Unchanged) ---
        const authCheck = () => {
            // If the app-content is visible (user is logged in), expand the container
            if (!appContent.classList.contains('hidden')) {
                mainContainer.classList.add('app-container');
            } else {
                mainContainer.classList.remove('app-container');
            }
        }
        
        // Observer watches the 'app-content' visibility to adjust the main container width
        const observer = new MutationObserver((mutationsList, observer) => {
            for(const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    authCheck();
                }
            }
        });

        observer.observe(appContent, { attributes: true });

        // Initial check
        authCheck();
    });
</script>

</body>
</html>