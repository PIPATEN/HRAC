<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Quiz</title> 
    <style>
        /* ÓÅûÊ≥ä GLOBAL RESIZING FOR MOBILE/COMPACT SCREENS */
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 10px; 
            background-color: #f4f4f9; 
            color: #333; 
            box-sizing: border-box; 
            min-height: 100vh; 
        }
        
        /* Back Link (Fixed Position) */
        .back-link {
            position: fixed; 
            top: 10px;
            left: 10px;
            z-index: 10;
            font-size: 14px;
            padding: 5px 8px;
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            border: 1px solid #007bff;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        /* üîë CLOCK STYLE (Fixed Position) */
        #timerDisplay {
            position: fixed; 
            top: 10px;
            right: 10px;
            z-index: 10;
            font-size: 16px;
            font-weight: bold;
            color: #dc3545; /* Red for visibility */
            padding: 5px 10px;
            border: 1px solid #dc3545;
            border-radius: 4px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .container { 
            max-width: 500px; 
            width: 100%;
            margin: 0 auto; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
            padding-top: 55px; /* Adjusted padding to accommodate fixed clock/link */
        }
        h1 { 
            text-align: center; 
            color: #0056b3; 
            font-size: 1.5em; 
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        /* SEGMENTED PROGRESS BAR STYLES */
        #progressBarContainer {
            width: 100%;
            margin-bottom: 5px; 
        }

        /* ÓÅûÊ≥ä UPDATED: Header for Progress Text and Best Score */
        #progressHeader {
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 3px; 
            font-size: 0.85em; 
            font-weight: bold;
            color: #343a40;
        }

        #progressSegmentsWrapper {
            position: relative; 
            padding-top: 12px; /* Space for the arrow */
        }
        
        #progressSegments {
            display: flex;
            height: 10px; 
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .segment {
            flex-grow: 1;
            height: 100%;
            margin-right: 1px; 
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .unanswered { background-color: #dc3545; }
        .answered { background-color: #28a745; }
        .reanswered { background-color: #ffc107; }

        #arrowIndicator {
            position: absolute;
            top: 0;
            width: 0; 
            height: 0;
            border-left: 8px solid transparent; 
            border-right: 8px solid transparent;
            border-top: 8px solid #007bff; 
            transition: left 0.3s ease-in-out;
            transform: translateX(-50%); 
            pointer-events: none; 
        }

        /* COMPACT LEGEND STYLES */
        #colorLegend {
            margin-top: 5px;
            padding: 5px 0; 
            border: none;
            background-color: transparent;
            font-size: 0.75em; 
            display: flex;
            justify-content: space-around; 
            flex-wrap: wrap;
        }

        #colorLegend .legend-item {
            display: flex;
            align-items: center;
            margin: 2px 5px; 
        }

        #colorLegend .color-box {
            width: 10px; 
            height: 10px;
            margin-right: 5px;
            border: 1px solid #333;
        }

        /* COMPACT QUESTION/OPTIONS */
        .question-card { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
        }
        .question-card p { 
            font-weight: bold; 
            font-size: 1em; 
            margin-bottom: 10px; 
        }
        
        .options label { 
            display: block; 
            margin: 7px 0; 
            padding: 8px; 
            font-size: 0.9em; 
            border: 1px solid #eee; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            position: relative;
        }
        .options label:hover { background-color: #eef; }

        .options input[type="radio"] { 
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        
        .options input[type="radio"]:checked ~ span {
            font-weight: bold;
            color: white;
            background-color: #007bff; 
            display: block;
            padding: 8px; 
            margin: -8px; 
            border-radius: 4px;
        }

        .options label span { 
            display: block; 
            padding: 0; 
        }

        /* Navigation Button Styling */
        #quizNavigation {
            display: flex;
            justify-content: space-between;
            margin-top: 10px; 
        }

        #quizNavigation button {
            padding: 10px 15px; 
            font-size: 16px; 
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            width: 48%; 
        }

        #prevQuestionButton {
            background-color: #ffc107; 
            color: #343a40;
        }
        
        #nextQuestionButton {
            background-color: #007bff; 
            color: white;
        }

        #quizNavigation button:disabled {
            background-color: #adb5bd; 
            cursor: not-allowed;
            opacity: 0.6;
            color: #495057;
        }
        
        .results { margin-top: 30px; border-top: 2px solid #0056b3; padding-top: 20px; }
        .score { font-size: 1.5em; font-weight: bold; text-align: center; margin-bottom: 20px; color: #28a745; }
        .hidden { display: none; }
    </style>
</head>
<body onload="loadQuizData()">

<a href="#" id="dynamicBackLink" class="back-link" onclick="return handleBackNavigation()">&larr; Back</a>

<div id="timerDisplay" style="display:none;">00:00</div>
<div class="container">
    <h1 id="quizTitle">Loading Quiz...</h1>
    
    <div id="progressBarContainer" class="hidden">
        <div id="progressHeader">
            <span id="progressCompletionText"></span>
            <span id="progressBestScoreText"></span>
        </div>
        
        <div id="progressSegmentsWrapper">
            <div id="arrowIndicator"></div>
            <div id="progressSegments">
                </div>
        </div>
    </div>
    
    <div id="colorLegend" class="hidden">
        <div class="legend-item"><div class="color-box" style="background-color: #dc3545;"></div> Unanswered (Red)</div>
        <div class="legend-item"><div class="color-box" style="background-color: #28a745;"></div> Answered (Green)</div>
        <div class="legend-item"><div class="color-box" style="background-color: #ffc107;"></div> Reanswered (Yellow)</div>
    </div>

    <div id="loadingMessage">Loading quiz data...</div>
    
    <div id="quizContainer" class="hidden">
        </div>

    <div id="quizNavigation" class="hidden">
        <button id="prevQuestionButton" onclick="changeQuestion(-1)">&#9664; Prev</button>
        <button id="nextQuestionButton" onclick="changeQuestion(1)">Next &#9654;</button>
    </div>
    <div id="resultsContainer" class="results hidden">
        <h2>Quiz Results</h2>
        <p id="scoreText" class="score"></p>
        <div id="detailedResults">
            </div>
        <button onclick="location.reload()" style="width: 100%; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 4px; margin-top: 20px;">Restart Quiz</button>
    </div>
</div>

<script>
    // --- Setup and Variables ---
    const urlParams = new URLSearchParams(window.location.search);
    const QUESTIONS_FILE = urlParams.get('qfile');
    const ANSWERS_FILE = urlParams.get('afile');
    const QUIZ_TITLE = urlParams.get('title') || 'Dynamic Shuffling Quiz Game';
    
    const BACK_PAGE = urlParams.get('bpage') || 'practice124.html'; 
    const BACK_PAGE_URL = `./${BACK_PAGE}`; 

    document.getElementById('dynamicBackLink').href = '#';
    document.title = QUIZ_TITLE;
    document.getElementById('quizTitle').textContent = QUIZ_TITLE;

    let quizData = []; 
    const optionMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
    let currentQuestionIndex = 0;
    // userAnswers stores objects { value: string|null, status: 'unanswered'|'answered'|'reanswered' }
    let userAnswers = []; 
    let quizSubmitted = false; 

    const quizContainer = document.getElementById('quizContainer');
    const loadingMessage = document.getElementById('loadingMessage');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressSegmentsDiv = document.getElementById('progressSegments'); 
    const arrowIndicator = document.getElementById('arrowIndicator');         
    const progressCompletionText = document.getElementById('progressCompletionText');
    const progressBestScoreText = document.getElementById('progressBestScoreText');
    
    const quizNavigation = document.getElementById('quizNavigation');
    const prevQuestionButton = document.getElementById('prevQuestionButton');
    const nextQuestionButton = document.getElementById('nextQuestionButton');
    const colorLegend = document.getElementById('colorLegend');
    const resultsContainer = document.getElementById('resultsContainer');
    const scoreText = document.getElementById('scoreText');
    const detailedResults = document.getElementById('detailedResults');
    
    // üîë TIMER VARIABLES
    let startTime;
    let timerInterval;
    const timerDisplay = document.getElementById('timerDisplay');
    // -------------------


    // --- Utility Functions (Shuffle, Process Data) ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function processTextData(questionText, answerText) {
        const lines = questionText.replace(/\r/g, '').split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const answers = answerText.replace(/\r/g, '').split('\n').map(line => line.trim().toUpperCase()).filter(line => line.length > 0);
        
        const data = [];
        const numQuestions = Math.floor(lines.length / 5);

        if (lines.length % 5 !== 0 || numQuestions !== answers.length) return []; 
        
        for (let i = 0; i < numQuestions; i++) {
            const startIndex = i * 5;
            const question = lines[startIndex];
            const options = [lines[startIndex + 1], lines[startIndex + 2], lines[startIndex + 3], lines[startIndex + 4]];
            const correctAnswer = options[optionMap[answers[i]]];

            data.push({ question: question, options: options, answer: correctAnswer });
        }
        return data;
    }

    // --- Progress Bar Functions ---

    function renderProgressBar() {
        progressSegmentsDiv.innerHTML = ''; 

        quizData.forEach((_, index) => {
            const segment = document.createElement('div');
            segment.className = 'segment';
            
            segment.onclick = () => {
                currentQuestionIndex = index;
                renderQuiz(currentQuestionIndex);
            };

            const status = userAnswers[index].status;
            segment.classList.add(status);

            progressSegmentsDiv.appendChild(segment);
        });

        // --- Progress Text and Best Score Update ---
        const totalQuestions = quizData.length;
        let answeredCount = userAnswers.filter(a => a.status === 'answered' || a.status === 'reanswered').length;
        let unansweredCount = totalQuestions - answeredCount;
        
        const answeredPercent = totalQuestions > 0 ? ((answeredCount / totalQuestions) * 100).toFixed(0) : 0;
        const unansweredPercent = totalQuestions > 0 ? ((unansweredCount / totalQuestions) * 100).toFixed(0) : 0;
        
        // 1. Retrieve Best Score Data from localStorage
        const storageKey = 'bestScore_' + QUIZ_TITLE.replace(/\s/g, ''); 
        const storedScoreString = localStorage.getItem(storageKey);
        // Default best score to 0 with 'N/A' date
        let bestScoreData = storedScoreString ? JSON.parse(storedScoreString) : { score: 0, date: 'N/A' };
        
        // 2. Update Completion Text
        progressCompletionText.innerHTML = 
            `**${answeredCount}/${totalQuestions}** (<span style="color: #28a745;">${answeredPercent}% Answered</span> | <span style="color: #dc3545;">${unansweredPercent}% Left</span>)`;

        // 3. Format and Update Best Score Text
        // ÓÅûÊ≥ä FIX: Only display the date if it is defined and not the placeholder 'N/A', to prevent "on undefined"
        const bestScoreDate = (bestScoreData.date && bestScoreData.date !== 'N/A') ? 
                             ` on ${bestScoreData.date}` : 
                             '';

        progressBestScoreText.innerHTML = 
            `Best Score: <span style="color: #007bff;">${bestScoreData.score}/${totalQuestions}${bestScoreDate}</span>`;

        positionArrow();
    }

    function positionArrow() {
        if (quizData.length === 0) return;
        const totalWidth = progressSegmentsDiv.clientWidth;
        const segmentWidth = totalWidth / quizData.length;
        
        const arrowPosition = (currentQuestionIndex * segmentWidth) + (segmentWidth / 2);
        
        arrowIndicator.style.left = `${arrowPosition}px`;
    }

    // --- Quiz Core Functions ---

    async function loadQuizData() {
        loadingMessage.classList.remove('hidden');
        quizContainer.classList.add('hidden');
        
        try {
            const [questionsResponse, answersResponse] = await Promise.all([
                fetch(QUESTIONS_FILE),
                fetch(ANSWERS_FILE)
            ]);

            const questionText = await questionsResponse.text();
            const answerText = await answersResponse.text();
            
            let processedData = processTextData(questionText, answerText);
            quizData = shuffleArray(processedData.slice(0, 40)); 
            
            userAnswers = new Array(quizData.length).fill(null).map(() => ({ 
                value: null, 
                status: 'unanswered' 
            }));

            loadingMessage.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            progressBarContainer.classList.remove('hidden'); 
            quizNavigation.classList.remove('hidden'); 
            colorLegend.classList.remove('hidden'); 

            renderQuiz(currentQuestionIndex);
            updateNavigationButtons(); 
            
            // üîë START THE TIMER HERE, AFTER THE QUIZ HAS SUCCESSFULLY LOADED
            startTimer(); 

        } catch (error) {
            console.error("Could not load quiz data:", error);
            loadingMessage.style.color = 'red';
            loadingMessage.textContent = `CRITICAL QUIZ LOAD ERROR: ${error.message}`;
            // If load fails, hide navigation and timer
            quizNavigation.classList.add('hidden');
            timerDisplay.style.display = 'none';
        }
    }
    
    function updateNavigationButtons() {
        prevQuestionButton.disabled = currentQuestionIndex === 0;

        if (currentQuestionIndex === quizData.length - 1) {
            nextQuestionButton.textContent = "Submit Quiz";
            nextQuestionButton.disabled = userAnswers[currentQuestionIndex].value === null; 
        } else {
            nextQuestionButton.textContent = "Next \u25b8"; 
            nextQuestionButton.disabled = false; 
        }
    }

    function renderQuiz(index) {
        if (quizData.length === 0) return;

        const item = quizData[index];
        quizContainer.innerHTML = ''; 
        
        const card = document.createElement('div');
        card.className = 'question-card';
        const questionText = document.createElement('p');
        questionText.textContent = `Q${index + 1}/${quizData.length}: ${item.question}`;
        card.appendChild(questionText);

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'options';
        
        item.options.forEach((option) => { 
            const label = document.createElement('label');
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `currentQuestion`; 
            radio.value = option;
            
            radio.addEventListener('change', handleAnswerClick);

            if (userAnswers[index].value === option) {
                radio.checked = true;
            }

            const optionSpan = document.createElement('span');
            optionSpan.textContent = option;
            
            label.appendChild(radio);
            label.appendChild(optionSpan);
            optionsDiv.appendChild(label);
        });

        card.appendChild(optionsDiv);
        quizContainer.appendChild(card);
        
        updateNavigationButtons();
        renderProgressBar(); 
    }

    function changeQuestion(direction) {
        if (direction === -1 && currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuiz(currentQuestionIndex);
        } else if (direction === 1) {
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                renderQuiz(currentQuestionIndex);
            } else if (currentQuestionIndex === quizData.length - 1) {
                if (userAnswers[currentQuestionIndex].value !== null) {
                    showResults();
                }
            }
        }
    }

    function handleAnswerClick(event) {
        const selectedValue = event.target.value;
        const currentAnswerState = userAnswers[currentQuestionIndex];
        
        if (currentAnswerState.value === null) {
            currentAnswerState.status = 'answered';
        } else if (currentAnswerState.value !== selectedValue) {
            currentAnswerState.status = 'reanswered';
        }
        
        currentAnswerState.value = selectedValue;

        renderProgressBar(); 
        updateNavigationButtons(); 

        if (currentQuestionIndex < quizData.length - 1) {
            // Auto advance after a brief delay
            setTimeout(() => {
                changeQuestion(1); 
            }, 200); 
        } 
    }

    // --- Score and Exit Functions ---

    function calculateAndSaveScore(exitEarly = false) {
        let score = 0;
        quizData.forEach((item, index) => {
            const selectedAnswer = userAnswers[index].value;
            if (selectedAnswer !== null && selectedAnswer === item.answer) {
                score++;
            }
        });
        
        const totalQuestions = quizData.length; 
        const storageKey = 'bestScore_' + QUIZ_TITLE.replace(/\s/g, ''); 
        
        const storedScoreString = localStorage.getItem(storageKey);
        // Default best score to 0 with 'N/A' date
        let bestScoreData = storedScoreString ? JSON.parse(storedScoreString) : { score: 0, date: 'N/A' };

        if (score > bestScoreData.score) {
            // New best score! Record the score AND the current date.
            const now = new Date();
            // ÓÅûÊ≥ä Format the date as 'Sat 11 Oct 24'
            const bestScoreDateString = now.toLocaleDateString('en-US', {
                weekday: 'short',
                day: '2-digit',
                month: 'short',
                year: '2-digit'
            }).replace(/,/g, ''); 
            
            const newBestScore = { 
                score: score, 
                date: bestScoreDateString
            };
            localStorage.setItem(storageKey, JSON.stringify(newBestScore));
            bestScoreData = newBestScore;
        }

        return score;
    }

    function showResults() {
        // üîë STOP THE TIMER
        stopTimer(); 
        
        const finalScore = calculateAndSaveScore(false); 
        quizSubmitted = true; 
        detailedResults.innerHTML = ''; 

        // üîë GET AND DISPLAY FINAL TIME
        const elapsedTime = timerDisplay.textContent; 
        
        // Create an element for the time
        const timeResult = document.createElement('p');
        timeResult.style.fontSize = '1.2em';
        timeResult.style.fontWeight = 'bold';
        timeResult.style.color = '#dc3545'; // Use a distinct color for time
        timeResult.style.marginBottom = '10px';
        timeResult.textContent = `Time Spent: ${elapsedTime}`;

        // Insert time result before the score text
        resultsContainer.querySelector('h2').insertAdjacentElement('afterend', timeResult);

        // Populate detailed results
        quizData.forEach((item, index) => {
            const selectedAnswer = userAnswers[index].value;
            const isCorrect = selectedAnswer === item.answer;

            const resultItem = document.createElement('div');
            resultItem.className = 'result-item ' + (isCorrect ? 'correct' : 'incorrect');
            
            if (isCorrect) {
                resultItem.innerHTML = `**Q${index + 1}: Correct!** (${item.question})`;
            } else {
                const userAnswerText = selectedAnswer ? selectedAnswer : "No answer selected";
                resultItem.innerHTML = `
                    **Q${index + 1}: Incorrect.** (${item.question})
                    <br>Your Answer: ${userAnswerText}
                    <span class="correct-answer">Correct Answer: ${item.answer}</span>
                `;
            }
            detailedResults.appendChild(resultItem);
        });

        scoreText.textContent = `You got ${finalScore} out of ${quizData.length} questions correct!`;
        
        // Toggle Visibility
        progressBarContainer.classList.add('hidden'); 
        colorLegend.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        quizContainer.classList.add('hidden');
        quizNavigation.classList.add('hidden');
        timerDisplay.style.display = 'none'; // Hide the timer after results
    }

    function handleBackNavigation() {
        if (quizSubmitted) {
            window.location.href = BACK_PAGE_URL;
            return false; 
        }
        
        const answeredCount = userAnswers.filter(a => a.value !== null).length;

        if (answeredCount === 0) {
            window.location.href = BACK_PAGE_URL;
            return false; 
        }

        const confirmation = confirm("You haven't finished your quiz. Do you want to exit and save your current score?");

        if (confirmation) {
            calculateAndSaveScore(true); 
            // üîë STOP THE TIMER ON EARLY EXIT
            stopTimer(); 
            window.location.href = BACK_PAGE_URL;
        }
        
        return false;
    }

    // ----------------------------------------------------
    // üîë TIMER FUNCTIONS
    // ----------------------------------------------------

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        timerDisplay.style.display = 'block'; // Make timer visible
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function updateTimer() {
        const elapsedTime = Date.now() - startTime;
        const totalSeconds = Math.floor(elapsedTime / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        const formattedMinutes = String(minutes).padStart(2, '0');
        const formattedSeconds = String(seconds).padStart(2, '0');

        timerDisplay.textContent = `${formattedMinutes}:${formattedSeconds}`;
    }

    // ----------------------------------------------------

    // Start the process: loadQuizData() is called via the <body> onload attribute
</script>

</body>
</html>